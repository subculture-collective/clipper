name: Deployment Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/deploy.sh'
      - 'scripts/rollback.sh'
      - 'scripts/blue-green-deploy.sh'
      - 'scripts/rollback-blue-green.sh'
      - 'scripts/test-deployment-harness.sh'
      - 'scripts/rollback-drill.sh'
      - '.github/workflows/deployment-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'scripts/deploy.sh'
      - 'scripts/rollback.sh'
      - 'scripts/blue-green-deploy.sh'
      - 'scripts/rollback-blue-green.sh'
      - 'scripts/test-deployment-harness.sh'
      - 'scripts/rollback-drill.sh'
      - '.github/workflows/deployment-tests.yml'
  schedule:
    # Run rollback drill every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      run_rollback_drill:
        description: 'Run rollback drill'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read

jobs:
  deployment-harness:
    name: Deployment Scripts Harness
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup test environment
        run: |
          mkdir -p /tmp/deployment-test-results
          chmod +x scripts/test-deployment-harness.sh
      
      - name: Run deployment harness tests
        id: harness
        env:
          DRY_RUN: 'true'
          MOCK: 'true'
          VERBOSE: 'false'
          TEST_RESULTS_DIR: /tmp/deployment-test-results
        run: |
          set -o pipefail
          scripts/test-deployment-harness.sh | tee /tmp/deployment-test-results/harness-output.log
        continue-on-error: false
      
      - name: Check exit code
        if: always()
        run: |
          if [ ${{ steps.harness.outcome }} != 'success' ]; then
            echo "::error::Deployment harness tests failed"
            exit 1
          fi
      
      - name: Upload harness test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-harness-results
          path: /tmp/deployment-test-results/
          retention-days: 30
      
      - name: Display test summary
        if: always()
        run: |
          if [ -f /tmp/deployment-test-results/harness-output.log ]; then
            echo "## Deployment Harness Test Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 /tmp/deployment-test-results/harness-output.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  rollback-drill:
    name: Rollback Drill
    runs-on: ubuntu-latest
    # Run on schedule or manual trigger, or when rollback scripts change
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[rollback-drill]')
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Docker environment
        run: |
          docker --version
          docker compose version
      
      - name: Setup drill environment
        run: |
          mkdir -p /tmp/rollback-drill
          chmod +x scripts/rollback-drill.sh
      
      - name: Run rollback drill (DRY_RUN)
        id: drill_dry
        env:
          DRY_RUN: 'true'
          DRILL_DIR: /tmp/rollback-drill-dry
          ENVIRONMENT: ci-drill
        run: |
          set -o pipefail
          scripts/rollback-drill.sh | tee /tmp/rollback-drill-dry-output.log
        continue-on-error: false
      
      - name: Run rollback drill (LIVE)
        id: drill_live
        if: |
          github.event_name == 'schedule' || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.run_rollback_drill == 'true')
        env:
          DRY_RUN: 'false'
          DRILL_DIR: /tmp/rollback-drill-live
          ENVIRONMENT: ci-drill
          CLEANUP: 'true'
        run: |
          set -o pipefail
          scripts/rollback-drill.sh | tee /tmp/rollback-drill-live-output.log
        continue-on-error: false
      
      - name: Check drill results
        if: always()
        run: |
          # Check dry run
          if [ ${{ steps.drill_dry.outcome }} != 'success' ]; then
            echo "::error::Rollback drill (DRY_RUN) failed"
            exit 1
          fi
          
          # Check live run if it was executed
          if [ "${{ steps.drill_live.outcome }}" != "skipped" ] && [ "${{ steps.drill_live.outcome }}" != "success" ]; then
            echo "::error::Rollback drill (LIVE) failed"
            exit 1
          fi
      
      - name: Upload drill results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rollback-drill-results
          path: |
            /tmp/rollback-drill-dry/
            /tmp/rollback-drill-live/
            /tmp/rollback-drill-*-output.log
          retention-days: 30
      
      - name: Display drill summary
        if: always()
        run: |
          echo "## Rollback Drill Summary" >> $GITHUB_STEP_SUMMARY
          
          # Dry run summary
          if [ -f /tmp/rollback-drill-dry/state/drill-report.txt ]; then
            echo "### DRY_RUN Mode" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/rollback-drill-dry/state/drill-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Live run summary
          if [ -f /tmp/rollback-drill-live/state/drill-report.txt ]; then
            echo "### LIVE Mode" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/rollback-drill-live/state/drill-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  test-script-syntax:
    name: Test Script Syntax
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Check deployment scripts syntax
        run: |
          echo "Checking script syntax..."
          
          SCRIPTS=(
            "scripts/deploy.sh"
            "scripts/rollback.sh"
            "scripts/blue-green-deploy.sh"
            "scripts/rollback-blue-green.sh"
            "scripts/test-deployment-harness.sh"
            "scripts/rollback-drill.sh"
          )
          
          ERRORS=0
          for script in "${SCRIPTS[@]}"; do
            if [ -f "$script" ]; then
              echo "Checking $script..."
              if ! bash -n "$script"; then
                echo "::error file=$script::Syntax error in $script"
                ERRORS=$((ERRORS + 1))
              fi
              
              # Run shellcheck (informational only)
              shellcheck "$script" || echo "::warning file=$script::shellcheck found issues"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS script(s) with syntax errors"
            exit 1
          fi
          
          echo "All scripts passed syntax check"

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [deployment-harness, test-script-syntax]
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup test environment
        run: |
          mkdir -p /tmp/integration-test
          chmod +x scripts/*.sh
      
      - name: Test deployment script components
        run: |
          # Test that scripts have required functions/checks
          
          echo "Testing deploy.sh..."
          grep -q "command_exists" scripts/deploy.sh || exit 1
          grep -q "BACKUP_TAG" scripts/deploy.sh || exit 1
          grep -q "health" scripts/deploy.sh || exit 1
          
          echo "Testing rollback.sh..."
          grep -q "BACKUP_TAG" scripts/rollback.sh || exit 1
          grep -q "docker tag" scripts/rollback.sh || exit 1
          
          echo "Testing blue-green-deploy.sh..."
          grep -q "detect_active_env\|ACTIVE_ENV" scripts/blue-green-deploy.sh || exit 1
          grep -q "blue\|green" scripts/blue-green-deploy.sh || exit 1
          
          echo "All component tests passed"
      
      - name: Verify DRY_RUN support in rotation scripts
        run: |
          # Check that credential rotation scripts support DRY_RUN
          
          ROTATION_SCRIPTS=(
            "scripts/rotate-api-keys.sh"
            "scripts/rotate-db-password.sh"
            "scripts/rotate-jwt-keys.sh"
          )
          
          for script in "${ROTATION_SCRIPTS[@]}"; do
            if [ -f "$script" ]; then
              echo "Checking $script for DRY_RUN support..."
              if grep -q "DRY_RUN\|dry-run" "$script"; then
                echo "✓ $script supports DRY_RUN"
              else
                echo "::warning file=$script::$script may not support DRY_RUN mode"
              fi
            fi
          done

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deployment-harness, rollback-drill, test-script-syntax, integration-test]
    if: failure() && (github.event_name == 'schedule' || github.event_name == 'push')
    permissions:
      contents: read
    
    steps:
      - name: Create failure summary
        run: |
          echo "## ⚠️ Deployment Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more deployment test jobs failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the test results and fix any issues before deploying." >> $GITHUB_STEP_SUMMARY

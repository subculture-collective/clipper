name: Blue/Green Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip smoke tests (not recommended)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Blue/Green Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://clipper.example.com' || 'https://staging.clipper.example.com' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ inputs.environment }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ inputs.environment }}-${{ steps.meta.outputs.timestamp }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ inputs.environment }}-${{ steps.meta.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.timestamp }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ inputs.environment }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ inputs.environment }}-${{ steps.meta.outputs.timestamp }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ inputs.environment }}-${{ steps.meta.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.meta.outputs.timestamp }}

      - name: Deploy with Blue/Green strategy
        uses: appleboy/ssh-action@v1.2.0
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          SKIP_TESTS: ${{ inputs.skip_tests }}
        with:
          host: ${{ inputs.environment == 'production' && secrets.PRODUCTION_HOST || secrets.STAGING_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          envs: ENVIRONMENT,SKIP_TESTS
          script: |
            set -e
            cd /opt/clipper

            # Pull latest images
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${ENVIRONMENT}
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${ENVIRONMENT}

            # Run blue/green deployment script
            ./scripts/deploy-blue-green.sh

            # Cleanup old images
            docker system prune -f

      - name: Run post-deployment smoke tests
        if: ${{ !inputs.skip_tests }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ inputs.environment == 'production' && secrets.PRODUCTION_HOST || secrets.STAGING_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/clipper
            BACKEND_URL="http://localhost:8080" ./scripts/smoke-tests.sh

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: false
        with:
          host: ${{ inputs.environment == 'production' && secrets.PRODUCTION_HOST || secrets.STAGING_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/clipper
            ./scripts/health-check.sh

      - name: Create deployment record
        if: success()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: Blue/Green" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: ${{ steps.meta.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: ${{ steps.meta.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ❌ Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment failed and should have been automatically rolled back." >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Execute rollback
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ inputs.environment == 'production' && secrets.PRODUCTION_HOST || secrets.STAGING_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/clipper

            # Detect and restart the previous environment
            if docker ps -a --format '{{.Names}}' | grep -q "clipper-backend-blue"; then
              PREVIOUS_ENV="blue"
            else
              PREVIOUS_ENV="green"
            fi

            echo "Rolling back to $PREVIOUS_ENV environment..."
            docker start "clipper-backend-$PREVIOUS_ENV"

            # Wait for service to be ready
            sleep 5

            # Verify rollback
            if curl -f http://localhost:8080/health; then
              echo "Rollback successful"
            else
              echo "Rollback failed - manual intervention required"
              exit 1
            fi

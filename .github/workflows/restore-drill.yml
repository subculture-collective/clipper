---
name: Restore Drill

on:
  schedule:
    # Run monthly on the 1st at 4 AM UTC
    - cron: '0 4 1 * *'
  workflow_dispatch:
    inputs:
      cloud_provider:
        description: 'Cloud provider (gcp, aws, azure)'
        required: false
        default: 'gcp'
      backup_bucket:
        description: 'Backup bucket name'
        required: false
        default: 'clipper-backups-prod'
      postgres_host:
        description: 'PostgreSQL host for restore test'
        required: false
        default: 'localhost'

jobs:
  restore-drill:
    name: Monthly Restore Drill
    runs-on: ubuntu-latest
    timeout-minutes: 120

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: clipper
          POSTGRES_PASSWORD: clipper_test_password
          POSTGRES_DB: clipper_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Cloud SDK (GCP)
        if: ${{ github.event.inputs.cloud_provider == 'gcp' || github.event.inputs.cloud_provider == '' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Configure AWS credentials
        if: ${{ github.event.inputs.cloud_provider == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Azure CLI
        if: ${{ github.event.inputs.cloud_provider == 'azure' }}
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create log directory
        run: |
          sudo mkdir -p /var/log/clipper
          sudo chown -R $USER:$USER /var/log/clipper

      - name: Wait for PostgreSQL to be ready
        run: |
          until pg_isready -h localhost -p 5432 -U clipper; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready!"

      - name: Run restore drill
        id: drill
        env:
          CLOUD_PROVIDER: ${{ github.event.inputs.cloud_provider || 'gcp' }}
          BACKUP_BUCKET: ${{ github.event.inputs.backup_bucket || secrets.BACKUP_BUCKET || 'clipper-backups-prod' }}
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          POSTGRES_HOST: ${{ github.event.inputs.postgres_host || 'localhost' }}
          POSTGRES_PORT: '5432'
          POSTGRES_USER: 'clipper'
          POSTGRES_PASSWORD: 'clipper_test_password'
          POSTGRES_DB: 'clipper_test'
          RTO_TARGET_SECONDS: '3600'  # 1 hour
          RPO_TARGET_SECONDS: '900'   # 15 minutes
          PROMETHEUS_PUSHGATEWAY: ${{ secrets.PROMETHEUS_PUSHGATEWAY }}
        run: |
          set +e
          bash scripts/restore-drill.sh
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Upload drill log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: restore-drill-log-${{ github.run_number }}
          path: /var/log/clipper/restore-drill.log
          retention-days: 90

      - name: Parse drill results
        if: always()
        id: results
        run: |
          if [ -f /var/log/clipper/restore-drill.log ]; then
            # Extract key metrics from log
            restore_duration=$(grep "Duration:" /var/log/clipper/restore-drill.log | grep -oP '\d+s' | head -1 | tr -d 's' || echo "0")
            rpo_seconds=$(grep "RPO (backup age):" /var/log/clipper/restore-drill.log | grep -oP '\d+s' | head -1 | tr -d 's' || echo "0")
            clip_count=$(grep "Clips count:" /var/log/clipper/restore-drill.log | grep -oP '\d+' || echo "0")
            user_count=$(grep "Users count:" /var/log/clipper/restore-drill.log | grep -oP '\d+' || echo "0")

            echo "restore_duration=$restore_duration" >> $GITHUB_OUTPUT
            echo "rpo_seconds=$rpo_seconds" >> $GITHUB_OUTPUT
            echo "clip_count=$clip_count" >> $GITHUB_OUTPUT
            echo "user_count=$user_count" >> $GITHUB_OUTPUT

            echo "### Restore Drill Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Restore Duration**: ${restore_duration}s (Target: 3600s)" >> $GITHUB_STEP_SUMMARY
            echo "- **RPO**: ${rpo_seconds}s (Target: 900s)" >> $GITHUB_STEP_SUMMARY
            echo "- **Clips Restored**: ${clip_count}" >> $GITHUB_STEP_SUMMARY
            echo "- **Users Restored**: ${user_count}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check drill result
        if: steps.drill.outputs.exit_code != '0'
        run: |
          echo "::error::Restore drill failed! RTO or RPO targets not met or validation failed."
          exit 1

      - name: Report success
        if: steps.drill.outputs.exit_code == '0'
        run: |
          echo "::notice::Restore drill succeeded! RTO < 1h and RPO < 15m demonstrated."
          cat /var/log/clipper/restore-drill.log

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš¨ Monthly Restore Drill Failed

            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_id }}

            Restore Duration: ${{ steps.results.outputs.restore_duration }}s (Target: 3600s)
            RPO: ${{ steps.results.outputs.rpo_seconds }}s (Target: 900s)

            Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_OPERATIONS }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_OPERATIONS }}

      - name: Notify on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âœ… Monthly Restore Drill Succeeded",
              "attachments": [{
                "color": "good",
                "fields": [
                  {
                    "title": "Restore Duration",
                    "value": "${{ steps.results.outputs.restore_duration }}s (Target: 3600s)",
                    "short": true
                  },
                  {
                    "title": "RPO",
                    "value": "${{ steps.results.outputs.rpo_seconds }}s (Target: 900s)",
                    "short": true
                  },
                  {
                    "title": "Clips Restored",
                    "value": "${{ steps.results.outputs.clip_count }}",
                    "short": true
                  },
                  {
                    "title": "Users Restored",
                    "value": "${{ steps.results.outputs.user_count }}",
                    "short": true
                  }
                ]
              }]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK_OPERATIONS }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_OPERATIONS }}

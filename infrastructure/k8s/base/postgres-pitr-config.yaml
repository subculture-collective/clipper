---
# PostgreSQL Configuration for Point-in-Time Recovery (PITR)
# Related to Roadmap 5.0 Phase 5.4 - Automated Backup & Recovery
# Issue: subculture-collective/clipper#863
#
# This configuration enables:
# 1. Write-Ahead Log (WAL) archiving
# 2. Point-in-Time Recovery with 7-day window
# 3. Continuous archiving to cloud storage
#
# Prerequisites:
# - Cloud storage bucket configured
# - ServiceAccount with write permissions to backup bucket

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-pitr-config
  namespace: clipper-production
  labels:
    app: postgres
    component: database
data:
  # PostgreSQL configuration for PITR
  postgresql.conf: |
    # WAL Configuration for PITR
    wal_level = replica
    archive_mode = on
    archive_command = '/var/lib/postgresql/archive-command.sh %f %p'
    archive_timeout = 300  # Archive WAL every 5 minutes
    
    # WAL retention
    wal_keep_size = 2GB  # Keep at least 2GB of WAL files
    max_wal_senders = 5
    
    # Checkpoint configuration
    checkpoint_timeout = 15min
    max_wal_size = 2GB
    min_wal_size = 80MB
    
    # Logging
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_duration = off
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    
    # Performance tuning
    shared_buffers = 256MB
    effective_cache_size = 1GB
    maintenance_work_mem = 64MB
    work_mem = 16MB
    
    # Connection settings
    max_connections = 100
    
  # Archive command script (cloud provider agnostic)
  archive-command.sh: |
    #!/bin/bash
    set -euo pipefail
    
    # Parameters passed by PostgreSQL
    WAL_FILE=$1
    WAL_PATH=$2
    
    ARCHIVE_DIR="/archive"
    CLOUD_PROVIDER="${CLOUD_PROVIDER:-gcp}"
    BACKUP_BUCKET="${BACKUP_BUCKET:-clipper-backups-prod}"
    
    # Copy WAL file to local archive directory first (for fast recovery)
    mkdir -p "${ARCHIVE_DIR}"
    cp "${WAL_PATH}" "${ARCHIVE_DIR}/${WAL_FILE}"
    
    # Upload to cloud storage based on provider
    case "${CLOUD_PROVIDER}" in
      gcp)
        gsutil -o "GSUtil:encryption_key=${ENCRYPTION_KEY:-}" \
          cp "${WAL_PATH}" "gs://${BACKUP_BUCKET}/wal-archive/${WAL_FILE}"
        ;;
      aws)
        aws s3 cp "${WAL_PATH}" \
          "s3://${BACKUP_BUCKET}/wal-archive/${WAL_FILE}" \
          --server-side-encryption AES256
        ;;
      azure)
        az storage blob upload \
          --account-name "${AZURE_STORAGE_ACCOUNT}" \
          --container-name "${BACKUP_BUCKET}" \
          --name "wal-archive/${WAL_FILE}" \
          --file "${WAL_PATH}" \
          --encryption-scope default
        ;;
      *)
        echo "Unknown cloud provider: ${CLOUD_PROVIDER}"
        exit 1
        ;;
    esac
    
    # Cleanup old local WAL files (keep 7 days)
    find "${ARCHIVE_DIR}" -type f -name "*.partial" -mtime +7 -delete 2>/dev/null || true
    find "${ARCHIVE_DIR}" -type f -mtime +7 -delete 2>/dev/null || true
    
    exit 0
    
  # Restore command script (for PITR)
  restore-command.sh: |
    #!/bin/bash
    set -euo pipefail
    
    # Parameters passed by PostgreSQL
    WAL_FILE=$1
    WAL_DEST=$2
    
    ARCHIVE_DIR="/archive"
    CLOUD_PROVIDER="${CLOUD_PROVIDER:-gcp}"
    BACKUP_BUCKET="${BACKUP_BUCKET:-clipper-backups-prod}"
    
    # Try local archive first (faster)
    if [ -f "${ARCHIVE_DIR}/${WAL_FILE}" ]; then
      cp "${ARCHIVE_DIR}/${WAL_FILE}" "${WAL_DEST}"
      exit 0
    fi
    
    # Download from cloud storage
    case "${CLOUD_PROVIDER}" in
      gcp)
        gsutil cp "gs://${BACKUP_BUCKET}/wal-archive/${WAL_FILE}" "${WAL_DEST}" 2>/dev/null
        ;;
      aws)
        aws s3 cp "s3://${BACKUP_BUCKET}/wal-archive/${WAL_FILE}" "${WAL_DEST}" 2>/dev/null
        ;;
      azure)
        az storage blob download \
          --account-name "${AZURE_STORAGE_ACCOUNT}" \
          --container-name "${BACKUP_BUCKET}" \
          --name "wal-archive/${WAL_FILE}" \
          --file "${WAL_DEST}" 2>/dev/null
        ;;
      *)
        echo "Unknown cloud provider: ${CLOUD_PROVIDER}"
        exit 1
        ;;
    esac
    
    exit 0

---
# StatefulSet patch for PostgreSQL with PITR enabled
# Apply this with: kubectl patch statefulset postgres -n clipper-production --patch-file postgres-pitr-patch.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: clipper-production
spec:
  template:
    spec:
      initContainers:
      - name: setup-pitr
        image: postgres:17-alpine
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          # Merge PITR configuration into existing PostgreSQL configuration
          if [ -f /var/lib/postgresql/data/postgresql.conf ]; then
            echo "Appending PITR configuration to existing postgresql.conf"
            cat /config/postgresql.conf >> /var/lib/postgresql/data/postgresql.conf
          else
            echo "Creating new postgresql.conf with PITR configuration"
            cp /config/postgresql.conf /var/lib/postgresql/data/postgresql.conf
          fi
          
          # Copy supporting scripts
          cp /config/archive-command.sh /var/lib/postgresql/archive-command.sh
          cp /config/restore-command.sh /var/lib/postgresql/restore-command.sh
          chmod +x /var/lib/postgresql/archive-command.sh
          chmod +x /var/lib/postgresql/restore-command.sh
          
          # Create archive directory
          mkdir -p /archive
          chown -R postgres:postgres /archive
          
          echo "PITR configuration completed"
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: postgres-pitr-config
          mountPath: /config
        - name: wal-archive
          mountPath: /archive
      containers:
      - name: postgres
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: wal-archive
          mountPath: /archive
        - name: postgres-pitr-config
          mountPath: /config
      volumes:
      - name: postgres-pitr-config
        configMap:
          name: postgres-pitr-config
          defaultMode: 0755
      - name: wal-archive
        emptyDir:
          sizeLimit: 5Gi

---
# PersistentVolumeClaim for WAL archive (optional, for local caching)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-wal-archive
  namespace: clipper-production
  labels:
    app: postgres
    component: wal-archive
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

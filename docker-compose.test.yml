services:
    opensearch-test:
        image: opensearchproject/opensearch:2.11.1
        container_name: clipper-opensearch-test
        environment:
            - discovery.type=single-node
            - 'OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m'
            - 'DISABLE_SECURITY_PLUGIN=true'
            - 'DISABLE_INSTALL_DEMO_CONFIG=true'
            - 'bootstrap.system_call_filter=false'
        ports:
            - '9201:9200'
            - '9601:9600'
        volumes:
            - opensearch-test-data:/usr/share/opensearch/data
        healthcheck:
            test: ['CMD-SHELL', 'curl -f http://localhost:9200/_cluster/health || exit 1']
            interval: 5s
            timeout: 5s
            retries: 15

    postgres-test:
        image: postgres:17-alpine
        container_name: clipper-postgres-test
        environment:
            POSTGRES_DB: clipper_test
            POSTGRES_PASSWORD: clipper_password
            POSTGRES_USER: clipper
        ports:
            - '5437:5432'
        tmpfs:
            - /var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U clipper -d clipper_test']
            interval: 5s
            timeout: 3s
            retries: 5

    redis-test:
        image: redis:7-alpine
        container_name: clipper-redis-test
        command: redis-server --appendonly yes --maxmemory 64mb --maxmemory-policy allkeys-lru
        ports:
            - '6380:6379'
        tmpfs:
            - /data
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 5s
            timeout: 3s
            retries: 5

volumes:
    opensearch-test-data:

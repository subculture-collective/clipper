# Caddyfile for CDN Failover Testing
# This configuration simulates CDN failures for testing purposes
# Use this in CI/staging environments to test failover behavior
#
# Enable failover testing mode:
#   export CDN_FAILOVER_MODE=true
#   caddy run --config Caddyfile.cdn-test

{
    # Global options
    admin localhost:2019
    log {
        output stdout
        format json
        level INFO
    }
}

# Test CDN endpoint that simulates failures
cdn-test.local:8081 {
    # CDN failure simulation endpoint
    # This simulates various CDN failure modes for testing
    
    route {
        # CDN failure simulation endpoint
        # This simulates various CDN failure modes for testing
        
        # Random failure injection based on request header
        # To simulate failures, clients should send: X-Test-CDN-Fail: true
        # In real testing, a middleware or proxy would inject this header randomly
        @fail_requests {
            header X-Test-CDN-Fail "true"
        }
        
        # Simulate timeout (return 504 Gateway Timeout immediately)
        # Note: Actual delays require custom middleware; this returns 504 instantly
        handle @fail_requests /timeout/* {
            respond "CDN Timeout" 504
        }
        
        # Simulate 5xx error
        handle @fail_requests /error/* {
            respond "CDN Service Unavailable" 503
        }
        
        # Simulate DNS failure (connection refused)
        handle @fail_requests /dns-fail/* {
            respond "CDN DNS Failure" 502
        }
        
        # Normal CDN response (simulate success)
        handle {
            header X-CDN-Cache "HIT"
            header X-CDN-Provider "test-cdn"
            reverse_proxy localhost:8082
        }
    }
}

# Origin server (fallback)
origin-test.local:8082 {
    # Origin server that serves content when CDN fails
    
    log {
        output stdout
        format json
        level INFO
    }
    
    # Static assets
    handle /assets/* {
        root * /var/www/clipper/assets
        file_server
        
        header X-Served-By "origin"
        header X-Fallback "true"
        header Cache-Control "public, max-age=300" # Shorter cache during failover
    }
    
    # HLS playlists
    handle /video/*.m3u8 {
        root * /var/www/clipper/hls
        file_server
        
        header Content-Type "application/vnd.apple.mpegurl"
        header X-Served-By "origin"
        header X-Fallback "true"
        header Cache-Control "public, max-age=60" # Short cache for playlists
    }
    
    # HLS segments
    handle /video/*.ts {
        root * /var/www/clipper/hls
        file_server
        
        header Content-Type "video/MP2T"
        header X-Served-By "origin"
        header X-Fallback "true"
        header Cache-Control "public, max-age=86400" # Long cache for segments
    }
    
    # Thumbnails
    handle /thumbnails/* {
        root * /var/www/clipper/thumbnails
        file_server
        
        header X-Served-By "origin"
        header X-Fallback "true"
        header Cache-Control "public, max-age=3600"
    }
    
    # Health check
    handle /health {
        respond "OK" 200
    }
}

# Main application server with CDN failover logic
localhost:8080 {
    log {
        output stdout
        format json
        level INFO
    }
    
    # API routes with CDN failover
    handle /api/v1/clips/*/thumbnail {
        # Primary CDN upstream with fallback to origin
        reverse_proxy cdn-test.local:8081 {
            # On CDN 5xx errors, fall back to origin
            @cdn_error status 5xx
            
            handle_response @cdn_error {
                # Add failover headers
                header X-CDN-Failover "true"
                header X-CDN-Failover-Reason "error"
                header X-CDN-Failover-Service "origin"
                
                # Fallback to origin upstream
                reverse_proxy origin-test.local:8082
            }
        }
    }
    
    handle /api/v1/video/* {
        # HLS content with CDN failover
        reverse_proxy cdn-test.local:8081 {
            # On CDN 5xx errors, fall back to origin
            @cdn_error status 5xx
            
            handle_response @cdn_error {
                # Add failover headers
                header X-CDN-Failover "true"
                header X-CDN-Failover-Reason "error"
                header X-CDN-Failover-Service "origin"
                
                # Fallback to origin upstream
                reverse_proxy origin-test.local:8082
            }
        }
    }
    
    # Backend API
    handle /api/* {
        reverse_proxy clipper-backend:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Frontend
    handle {
        reverse_proxy clipper-frontend:80
    }
}

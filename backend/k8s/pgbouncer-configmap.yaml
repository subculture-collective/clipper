apiVersion: v1
kind: ConfigMap
metadata:
  name: pgbouncer-config
  labels:
    app: pgbouncer
data:
  pgbouncer.ini: |
    [databases]
    clipper_db = host=postgres port=5432 dbname=clipper_db
    
    [pgbouncer]
    # Connection settings
    listen_addr = 0.0.0.0
    listen_port = 6432
    auth_type = md5
    auth_file = /etc/pgbouncer/userlist.txt
    
    # Pool configuration - Transaction mode for optimal connection reuse
    pool_mode = transaction
    max_client_conn = 500
    default_pool_size = 50
    min_pool_size = 10
    reserve_pool_size = 5
    reserve_pool_timeout = 5
    
    # Connection limits per user/database
    max_db_connections = 50
    max_user_connections = 50
    
    # Timeouts
    server_idle_timeout = 600
    server_lifetime = 3600
    server_connect_timeout = 15
    query_timeout = 0
    query_wait_timeout = 120
    client_idle_timeout = 0
    idle_transaction_timeout = 0
    
    # Logging
    log_connections = 1
    log_disconnections = 1
    log_pooler_errors = 1
    stats_period = 60
    
    # Admin settings
    admin_users = postgres
    stats_users = postgres
    
    # Performance tuning
    server_reset_query = DISCARD ALL
    server_reset_query_always = 0
    server_check_delay = 30
    server_check_query = SELECT 1
    
    # Client connection defaults
    application_name_add_host = 1
    autodb_idle_timeout = 3600
    
    # Security
    ignore_startup_parameters = extra_float_digits
    
    # Resource limits
    max_packet_size = 2147483647
    pkt_buf = 4096
    sbuf_loopcnt = 5
    tcp_keepalive = 1
    tcp_keepcnt = 5
    tcp_keepidle = 30
    tcp_keepintvl = 10

# API Endpoint Performance Targets
# This file defines p50/p95/p99 latency targets and throughput goals for top 20 endpoints
# Targets are based on expected user experience and backend capacity

version: "1.0"
last_updated: "2025-12-26"

# Global defaults for endpoints not specifically configured
defaults:
  p50_ms: 25
  p95_ms: 100
  p99_ms: 200
  error_rate: 0.01  # 1%
  min_throughput_rps: 10

# Top 20 endpoints by traffic/importance with specific targets
endpoints:
  # === Feed & Discovery (High Traffic) ===
  
  - name: "List Clips (Feed)"
    path: "/api/v1/clips"
    method: "GET"
    importance: "critical"
    expected_traffic: "high"
    targets:
      p50_ms: 20
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.005  # 0.5%
      min_throughput_rps: 50
    description: "Main feed endpoint - hot, new, top sorting"
    cache_strategy: "5min TTL with tags for invalidation"
    notes: "Most accessed endpoint, needs aggressive caching"

  - name: "Get Clip Detail"
    path: "/api/v1/clips/:id"
    method: "GET"
    importance: "critical"
    expected_traffic: "high"
    targets:
      p50_ms: 15
      p95_ms: 50
      p99_ms: 100
      error_rate: 0.005
      min_throughput_rps: 40
    description: "Individual clip metadata and details"
    cache_strategy: "10min TTL with invalidation on update"
    notes: "High read volume, strong caching candidate"

  - name: "Get Related Clips"
    path: "/api/v1/clips/:id/related"
    method: "GET"
    importance: "high"
    expected_traffic: "high"
    targets:
      p50_ms: 25
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.01
      min_throughput_rps: 30
    description: "Algorithm-based related clips recommendation"
    cache_strategy: "15min TTL, can tolerate staleness"
    notes: "Complex query, benefits from caching"

  # === Search (High Traffic) ===
  
  - name: "Search Clips"
    path: "/api/v1/search"
    method: "GET"
    importance: "critical"
    expected_traffic: "high"
    targets:
      p50_ms: 30
      p95_ms: 100
      p99_ms: 200
      error_rate: 0.01
      min_throughput_rps: 25
    description: "Full-text and hybrid search with filters"
    cache_strategy: "Query result caching for popular terms"
    notes: "OpenSearch/FTS, optimize for common queries"

  - name: "Search Suggestions"
    path: "/api/v1/search/suggestions"
    method: "GET"
    importance: "high"
    expected_traffic: "high"
    targets:
      p50_ms: 15
      p95_ms: 50
      p99_ms: 100
      error_rate: 0.005
      min_throughput_rps: 30
    description: "Autocomplete suggestions for search"
    cache_strategy: "Aggressive caching, 1hr TTL"
    notes: "Very latency-sensitive for UX"

  - name: "Trending Searches"
    path: "/api/v1/search/trending"
    method: "GET"
    importance: "medium"
    expected_traffic: "medium"
    targets:
      p50_ms: 20
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.01
      min_throughput_rps: 15
    description: "Popular search queries analytics"
    cache_strategy: "30min TTL, can be stale"
    notes: "Analytics endpoint, less latency-sensitive"

  # === Comments & Engagement (High Traffic) ===
  
  - name: "List Comments"
    path: "/api/v1/clips/:id/comments"
    method: "GET"
    importance: "high"
    expected_traffic: "high"
    targets:
      p50_ms: 20
      p95_ms: 50
      p99_ms: 100
      error_rate: 0.005
      min_throughput_rps: 35
    description: "Paginated comments for a clip"
    cache_strategy: "5min TTL, invalidate on new comment"
    notes: "Watch for N+1 queries with user data"

  - name: "Create Comment"
    path: "/api/v1/clips/:id/comments"
    method: "POST"
    importance: "high"
    expected_traffic: "medium"
    targets:
      p50_ms: 30
      p95_ms: 100
      p99_ms: 200
      error_rate: 0.01
      min_throughput_rps: 15
    description: "Create new comment on clip"
    cache_strategy: "Invalidate clip comments cache"
    notes: "Write operation, includes notification triggers"

  - name: "Vote on Clip"
    path: "/api/v1/clips/:id/vote"
    method: "POST"
    importance: "high"
    expected_traffic: "medium"
    targets:
      p50_ms: 20
      p95_ms: 50
      p99_ms: 100
      error_rate: 0.01
      min_throughput_rps: 20
    description: "Upvote/downvote a clip"
    cache_strategy: "Update vote count cache"
    notes: "Hot path, optimize for concurrent votes"

  - name: "Vote on Comment"
    path: "/api/v1/comments/:id/vote"
    method: "POST"
    importance: "medium"
    expected_traffic: "medium"
    targets:
      p50_ms: 20
      p95_ms: 50
      p99_ms: 100
      error_rate: 0.01
      min_throughput_rps: 15
    description: "Upvote/downvote a comment"
    cache_strategy: "Update comment vote cache"
    notes: "Similar pattern to clip voting"

  # === User Profiles & Activity ===
  
  - name: "Get User Profile"
    path: "/api/v1/users/:id"
    method: "GET"
    importance: "high"
    expected_traffic: "medium"
    targets:
      p50_ms: 20
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.005
      min_throughput_rps: 20
    description: "User profile with stats and activity"
    cache_strategy: "15min TTL with user-specific key"
    notes: "Includes aggregated stats, optimize queries"

  - name: "Get User Clips"
    path: "/api/v1/users/:id/clips"
    method: "GET"
    importance: "high"
    expected_traffic: "medium"
    targets:
      p50_ms: 25
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.01
      min_throughput_rps: 20
    description: "Paginated list of user's clips"
    cache_strategy: "10min TTL, invalidate on new clip"
    notes: "High value for creator profiles"

  - name: "Get User Activity"
    path: "/api/v1/users/:id/activity"
    method: "GET"
    importance: "medium"
    expected_traffic: "medium"
    targets:
      p50_ms: 30
      p95_ms: 100
      p99_ms: 200
      error_rate: 0.01
      min_throughput_rps: 15
    description: "User activity feed (comments, votes, etc)"
    cache_strategy: "5min TTL"
    notes: "Complex aggregation, consider materialized view"

  # === Authentication ===
  
  - name: "Get Current User"
    path: "/api/v1/auth/me"
    method: "GET"
    importance: "critical"
    expected_traffic: "high"
    targets:
      p50_ms: 15
      p95_ms: 40
      p99_ms: 75
      error_rate: 0.005
      min_throughput_rps: 30
    description: "Get authenticated user profile"
    cache_strategy: "Session-based cache, 5min"
    notes: "Called on every page load for logged-in users"

  - name: "Refresh Token"
    path: "/api/v1/auth/refresh"
    method: "POST"
    importance: "critical"
    expected_traffic: "medium"
    targets:
      p50_ms: 25
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.005
      min_throughput_rps: 10
    description: "Refresh JWT access token"
    cache_strategy: "N/A - writes to database"
    notes: "Security-critical, maintain low latency"

  # === Tags & Categories ===
  
  - name: "Get Clip Tags"
    path: "/api/v1/clips/:id/tags"
    method: "GET"
    importance: "medium"
    expected_traffic: "high"
    targets:
      p50_ms: 15
      p95_ms: 40
      p99_ms: 75
      error_rate: 0.005
      min_throughput_rps: 25
    description: "Tags associated with a clip"
    cache_strategy: "10min TTL with clip"
    notes: "Often fetched with clip detail"

  - name: "List Tags"
    path: "/api/v1/tags"
    method: "GET"
    importance: "medium"
    expected_traffic: "medium"
    targets:
      p50_ms: 20
      p95_ms: 50
      p99_ms: 100
      error_rate: 0.005
      min_throughput_rps: 15
    description: "Browse all tags with counts"
    cache_strategy: "30min TTL"
    notes: "Infrequently changed, heavy caching"

  - name: "Get Clips by Tag"
    path: "/api/v1/tags/:slug/clips"
    method: "GET"
    importance: "high"
    expected_traffic: "medium"
    targets:
      p50_ms: 25
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.01
      min_throughput_rps: 20
    description: "Clips filtered by tag"
    cache_strategy: "10min TTL per tag"
    notes: "Similar to feed, cache aggressively"

  # === Analytics & Tracking ===
  
  - name: "Track Clip View"
    path: "/api/v1/clips/:id/track-view"
    method: "POST"
    importance: "medium"
    expected_traffic: "high"
    targets:
      p50_ms: 10
      p95_ms: 30
      p99_ms: 75
      error_rate: 0.02  # Can tolerate higher error rate
      min_throughput_rps: 40
    description: "Analytics event for clip view"
    cache_strategy: "Async write, batching"
    notes: "Fire-and-forget, consider async processing"

  - name: "Get Clip Analytics"
    path: "/api/v1/clips/:id/analytics"
    method: "GET"
    importance: "medium"
    expected_traffic: "medium"
    targets:
      p50_ms: 25
      p95_ms: 75
      p99_ms: 150
      error_rate: 0.01
      min_throughput_rps: 15
    description: "View counts and engagement metrics"
    cache_strategy: "15min TTL, eventual consistency OK"
    notes: "Analytics data, can be slightly stale"

# Additional configuration
monitoring:
  prometheus_enabled: true
  export_metrics_per_endpoint: true
  alert_on_threshold_breach: true
  report_frequency: "daily"

profiling:
  enable_query_logging: true
  enable_explain_analyze: true
  detect_n_plus_one: true
  slow_query_threshold_ms: 100

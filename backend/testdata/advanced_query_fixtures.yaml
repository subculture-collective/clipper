# Advanced Query Test Fixtures
# These fixtures validate that the query translator produces correct SQL/ES output
# for various query patterns

version: "1.0"
description: "Test fixtures for advanced query translator module"
created_at: "2024-12-06"

# ============================================================================
# SIMPLE EQUALITY QUERIES
# ============================================================================

equality_queries:
  - id: "eq-001"
    description: "Simple string equality"
    input: "status = 'active'"
    expected_sql:
      where: "status = $1"
      args: ["active"]
    expected_es:
      term:
        status: "active"

  - id: "eq-002"
    description: "Numeric equality"
    input: "vote_score = 100"
    expected_sql:
      where: "vote_score = $1"
      args: [100]
    expected_es:
      term:
        vote_score: 100

  - id: "eq-003"
    description: "Not equals"
    input: "status != 'deleted'"
    expected_sql:
      where: "status != $1"
      args: ["deleted"]
    expected_es:
      bool:
        must_not:
          - term:
              status: "deleted"

# ============================================================================
# COMPARISON QUERIES
# ============================================================================

comparison_queries:
  - id: "cmp-001"
    description: "Greater than"
    input: "vote_score > 50"
    expected_sql:
      where: "vote_score > $1"
      args: [50]
    expected_es:
      range:
        vote_score:
          gt: 50

  - id: "cmp-002"
    description: "Greater than or equal"
    input: "vote_score >= 50"
    expected_sql:
      where: "vote_score >= $1"
      args: [50]
    expected_es:
      range:
        vote_score:
          gte: 50

  - id: "cmp-003"
    description: "Less than"
    input: "vote_score < 50"
    expected_sql:
      where: "vote_score < $1"
      args: [50]
    expected_es:
      range:
        vote_score:
          lt: 50

  - id: "cmp-004"
    description: "Less than or equal"
    input: "vote_score <= 50"
    expected_sql:
      where: "vote_score <= $1"
      args: [50]
    expected_es:
      range:
        vote_score:
          lte: 50

# ============================================================================
# RANGE QUERIES (BETWEEN)
# ============================================================================

range_queries:
  - id: "rng-001"
    description: "Numeric range"
    input: "vote_score BETWEEN 10 AND 100"
    expected_sql:
      where: "vote_score BETWEEN $1 AND $2"
      args: [10, 100]
    expected_es:
      range:
        vote_score:
          gte: 10
          lte: 100

  - id: "rng-002"
    description: "Date range"
    input: "created_at BETWEEN '2024-01-01' AND '2024-12-31'"
    expected_sql:
      where: "created_at BETWEEN $1 AND $2"
      args: ["2024-01-01", "2024-12-31"]
    expected_es:
      range:
        created_at:
          gte: "2024-01-01"
          lte: "2024-12-31"

# ============================================================================
# IN QUERIES
# ============================================================================

in_queries:
  - id: "in-001"
    description: "IN with strings"
    input: "status IN ('active', 'pending', 'featured')"
    expected_sql:
      where: "status IN ($1, $2, $3)"
      args: ["active", "pending", "featured"]
    expected_es:
      terms:
        status: ["active", "pending", "featured"]

  - id: "in-002"
    description: "IN with numbers"
    input: "game_id IN (1, 2, 3)"
    expected_sql:
      where: "game_id IN ($1, $2, $3)"
      args: [1, 2, 3]
    expected_es:
      terms:
        game_id: [1, 2, 3]

  - id: "in-003"
    description: "NOT IN"
    input: "status NOT IN ('deleted', 'removed')"
    expected_sql:
      where: "status NOT IN ($1, $2)"
      args: ["deleted", "removed"]
    expected_es:
      bool:
        must_not:
          - terms:
              status: ["deleted", "removed"]

# ============================================================================
# LOGICAL OPERATORS
# ============================================================================

logical_queries:
  - id: "log-001"
    description: "Simple AND"
    input: "status = 'active' AND score > 50"
    expected_sql:
      where: "(status = $1 AND score > $2)"
      args: ["active", 50]
    expected_es:
      bool:
        must:
          - term:
              status: "active"
          - range:
              score:
                gt: 50

  - id: "log-002"
    description: "Simple OR"
    input: "status = 'active' OR status = 'featured'"
    expected_sql:
      where: "(status = $1 OR status = $2)"
      args: ["active", "featured"]
    expected_es:
      bool:
        should:
          - term:
              status: "active"
          - term:
              status: "featured"
        minimum_should_match: 1

  - id: "log-003"
    description: "NOT expression"
    input: "NOT status = 'deleted'"
    expected_sql:
      where: "NOT (status = $1)"
      args: ["deleted"]
    expected_es:
      bool:
        must_not:
          - term:
              status: "deleted"

  - id: "log-004"
    description: "Complex nested expression"
    input: "(status = 'active' OR status = 'featured') AND score > 50"
    expected_sql:
      where: "((status = $1 OR status = $2) AND score > $3)"
      args: ["active", "featured", 50]
    expected_es:
      bool:
        must:
          - bool:
              should:
                - term:
                    status: "active"
                - term:
                    status: "featured"
              minimum_should_match: 1
          - range:
              score:
                gt: 50

# ============================================================================
# NULL CHECKS
# ============================================================================

null_queries:
  - id: "null-001"
    description: "IS NULL"
    input: "email IS NULL"
    expected_sql:
      where: "email IS NULL"
      args: []
    expected_es:
      bool:
        must_not:
          - exists:
              field: "email"

  - id: "null-002"
    description: "IS NOT NULL"
    input: "email IS NOT NULL"
    expected_sql:
      where: "email IS NOT NULL"
      args: []
    expected_es:
      exists:
        field: "email"

# ============================================================================
# LIKE/PATTERN QUERIES
# ============================================================================

like_queries:
  - id: "like-001"
    description: "LIKE with prefix wildcard"
    input: "title LIKE '%valorant%'"
    expected_sql:
      where: "title LIKE $1"
      args: ["%valorant%"]
    expected_es:
      wildcard:
        title:
          value: "*valorant*"
          case_insensitive: false

  - id: "like-002"
    description: "ILIKE case-insensitive"
    input: "title ILIKE '%VALORANT%'"
    expected_sql:
      where: "title ILIKE $1"
      args: ["%VALORANT%"]
    expected_es:
      wildcard:
        title:
          value: "*VALORANT*"
          case_insensitive: true

# ============================================================================
# COMPLEX REAL-WORLD QUERIES
# ============================================================================

complex_queries:
  - id: "complex-001"
    description: "Clip search with multiple filters"
    input: "is_removed = 0 AND game_id = 'valorant' AND vote_score >= 10 AND created_at > '2024-01-01'"
    expected_behavior: "Find non-removed Valorant clips with 10+ votes from 2024"

  - id: "complex-002"
    description: "Search for featured or popular content"
    input: "(is_featured = 1 OR vote_score >= 100) AND is_nsfw = 0 AND is_removed = 0"
    expected_behavior: "Find featured or highly upvoted clips that are SFW and not removed"

  - id: "complex-003"
    description: "Creator-specific search"
    input: "creator_id = 'shroud' AND game_id IN ('csgo', 'valorant', 'apex')"
    expected_behavior: "Find clips by shroud in specific FPS games"

  - id: "complex-004"
    description: "Time-bounded trending search"
    input: "vote_score > 50 AND created_at BETWEEN '2024-01-01' AND '2024-03-31'"
    expected_behavior: "Find popular clips from Q1 2024"

# ============================================================================
# SAFETY/LIMIT TEST CASES
# ============================================================================

safety_tests:
  - id: "safety-001"
    description: "Query without explicit limit should get default"
    input: "status = 'active'"
    expected_limit: 20  # default
    expected_max_limit: 100

  - id: "safety-002"
    description: "Query with excessive limit should be capped"
    input: "status = 'active'"
    requested_limit: 1000
    expected_limit: 100  # max

  - id: "safety-003"
    description: "Deeply nested query should be rejected"
    depth: 15
    expected_error: "MAX_DEPTH_EXCEEDED"

  - id: "safety-004"
    description: "IN clause with too many values should be rejected"
    max_in_values: 10
    actual_in_values: 100
    expected_error: "TOO_MANY_IN_VALUES"

  - id: "safety-005"
    description: "SQL injection attempt in field name"
    input: "status; DROP TABLE--"
    expected_error: "INVALID_FIELD_NAME"

# ============================================================================
# PAGINATION TEST CASES
# ============================================================================

pagination_tests:
  - id: "page-001"
    description: "First page"
    page: 1
    limit: 20
    expected_offset: 0

  - id: "page-002"
    description: "Second page"
    page: 2
    limit: 20
    expected_offset: 20

  - id: "page-003"
    description: "Tenth page"
    page: 10
    limit: 20
    expected_offset: 180

  - id: "page-004"
    description: "Custom limit"
    page: 3
    limit: 50
    expected_offset: 100
